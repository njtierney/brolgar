---
title: "Exploratory Modelling"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{exploratory-modelling}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
options(rmarkdown.html_vignette.check_title = FALSE)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(brolgar)
```

A statistical model is typically used to **predict** future observations, or  **explain** and understand data. This vignette focuses on how to apply a statistical model ("fit a model") to explore your data. 

A linear model is a common statistical method in data analysis. One approach to understand the many different groups in data is to fit a linear model for each group in a dataset. For example, in a dataset of heights over time for each country:

```{r show-heights}
heights
```

We can fit a separate linear model for each country in the data. As discussed in the vignette, "longitudinal data structures", the country column in this dataset is the "key". `brolgar` provides a helper function to help fit a linear model to each key, called `key_slope()`, which returns the intercept and slope estimate for each key. 

The `key_slope()` function has two arguments, `data`, and `formula`. We specify the data, which needs to be a `tsibble` object (see vignette, "longitudinal data structures" for more information on `tsibble`), and the `formula`, which is written like so: `y ~ x`. Where `y` is the response, and `x` is an explanatory variable. For example, we can fit a linear model to each `key` like so:

```{r use-gghighlight}
key_slope(wages, ln_wages ~ xp)
```

This fits a `linear` model to each individual (`id`) in the wages group (as they are specified as the `key`), with `ln_wages` as the response, and `xp` as the explanatory variable. This provides the number of observations, and slope information for each individual to identify those that are decreasing over time. 

We can then join these summaries back to the data:

```{r show-wages-lg}
library(dplyr)
wages_slope <- key_slope(wages,ln_wages ~ xp) %>%
  left_join(wages, by = "id") 

wages_slope
```

And highlight those individuals with a negative slope using `gghighlight`:

```{r use-gg-highlight}
library(gghighlight)

wages_slope %>% 
  as_tibble() %>% # workaround for gghighlight + tsibble
  ggplot(aes(x = xp, 
             y = ln_wages, 
             group = id)) + 
  geom_line() +
  gghighlight(.slope_xp < 0)
```

# Find keys near other summaries with `keys_near()`

We might want to further summarise our exploratory modelling by finding those slopes that are near a five number summary values:

```{r summary-slope}
summary(wages_slope$.slope_xp)
```

Finding those groups that are near these values can be surprisingly challenging!

`brolgar` makes it easier by providing the `keys_near()` function. You tell it what the key is, what variable you want to summarise by, and then by default it returns those keys near the five number summary. Let's return the keys near the `.slope_xp`:

```{r keys-near}
wages_slope %>%
  keys_near(key = id,
            var = .slope_xp)
```

Here it returns the `id`, the `.slope_xp`, and the statistic that it was closest to, and what the difference between the slope_xp and the statistic.

You can visualise these summary keys by joining them back to the data:

```{r keys-near-plot}
wages_slope %>%
  keys_near(key = id,
            var = .slope_xp) %>%
  left_join(wages, by = "id") %>%
  ggplot(aes(x = xp,
             y = ln_wages,
             group = id,
             colour = stat)) + 
  geom_line()
```

You can read more about `keys_near()` in the [Identifying interesting observations](http://brolgar.njtierney.com/articles/id-interesting-obs.html) vignette.
